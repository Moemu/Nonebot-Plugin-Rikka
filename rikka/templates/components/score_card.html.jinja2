{# 定义难度背景映射 #}
{% set DIFFICULTY_BG = {
  'basic': 'static/mai/pic/b50_score_basic.png',
  'advanced': 'static/mai/pic/b50_score_advanced.png',
  'expert': 'static/mai/pic/b50_score_expert.png',
  'master': 'static/mai/pic/b50_score_master.png',
  'remaster': 'static/mai/pic/b50_score_remaster.png'
} %}

{% set RANK_ICON = {
  'd': 'static/mai/pic/UI_TTR_Rank_D.png',
  'c': 'static/mai/pic/UI_TTR_Rank_C.png',
  'b': 'static/mai/pic/UI_TTR_Rank_B.png',
  'bb': 'static/mai/pic/UI_TTR_Rank_BB.png',
  'a': 'static/mai/pic/UI_TTR_Rank_A.png',
  'aa': 'static/mai/pic/UI_TTR_Rank_AA.png',
  'aaa': 'static/mai/pic/UI_TTR_Rank_AAA.png',
  's': 'static/mai/pic/UI_TTR_Rank_S.png',
  'sp': 'static/mai/pic/UI_TTR_Rank_Sp.png',
  'ss': 'static/mai/pic/UI_TTR_Rank_SS.png',
  'ssp': 'static/mai/pic/UI_TTR_Rank_SSp.png',
  'sss': 'static/mai/pic/UI_TTR_Rank_SSS.png',
  'sssp': 'static/mai/pic/UI_TTR_Rank_SSSp.png'
} %}

{% set COMBO_ICON = {
  'fc': 'static/mai/pic/UI_MSS_MBase_Icon_FC.png',
  'fcp': 'static/mai/pic/UI_MSS_MBase_Icon_FCp.png',
  'ap': 'static/mai/pic/UI_MSS_MBase_Icon_AP.png',
  'app': 'static/mai/pic/UI_MSS_MBase_Icon_APP.png'
} %}

{% set SYNC_ICON = {
  'sync': 'static/mai/pic/UI_MSS_MBase_Icon_Sync.png',
  'fs': 'static/mai/pic/UI_MSS_MBase_Icon_FS.png',
  'fsp': 'static/mai/pic/UI_MSS_MBase_Icon_FSp.png',
  'fsd': 'static/mai/pic/UI_MSS_MBase_Icon_FSD.png',
  'fsdp': 'static/mai/pic/UI_MSS_MBase_Icon_FSDp.png'
} %}

{% set DX_STAR_ICON = {
  1: 'static/mai/pic/UI_GAM_Gauge_DXScoreIcon_01.png',
  2: 'static/mai/pic/UI_GAM_Gauge_DXScoreIcon_02.png',
  3: 'static/mai/pic/UI_GAM_Gauge_DXScoreIcon_03.png',
  4: 'static/mai/pic/UI_GAM_Gauge_DXScoreIcon_04.png',
  5: 'static/mai/pic/UI_GAM_Gauge_DXScoreIcon_05.png'
} %}

{% macro score_card(score) %}
<article class="relative h-[109px] overflow-hidden shadow-[0_18px_32px_-18px_rgba(7,89,133,0.35)]">
  {# 背景图 #}
  <img
    src="{{ DIFFICULTY_BG[score.difficulty] }}"
    alt="{{ score.difficulty }} background"
    class="absolute inset-0 w-full h-full object-cover"
  />

  <div class="relative flex h-full items-stretch gap-1 px-2.5 py-1">
    {# 封面图 #}
    <div class="relative my-1 h-[80px] w-[80px] overflow-hidden border-3 border-white">
      <img
        src="{{ 'static/mai/cover/' ~ (score.cover or '0') ~ '.png' }}"
        alt="{{ score.title }} cover"
        class="w-full h-full object-cover"
        onerror="this.src='static/mai/cover/0.png'"
      />
      <div class="absolute left-0.5 top-1 flex items-center gap-1 px-0.5 py-[1px]">
        <img
          src="{{ 'static/mai/pic/DX.png' if score.chartType == 'DX' else 'static/mai/pic/SD.png' }}"
          alt="{{ score.chartType }} icon"
          width="35"
          height="13"
          class="object-contain"
        />
      </div>
    </div>

    {# 歌曲信息 #}
    <div class="flex flex-1 flex-col justify-start">
      <div class="flex items-start gap-2">
        <span class="line-clamp-1 w-full text-[14px] font-[ResourceHanRoundedCN] text-white">
          {{ score.title }}
        </span>
        <span class="mr-[-4em] line-clamp-1 w-full text-[14px] font-[ResourceHanRoundedCN] text-white">
          PC: {{ score.pc }}
        </span>
      </div>

      <div class="text-2xl font-bold font-[ResourceHanRoundedCN] text-white">
        {{ "%.4f" | format(score.achievement) }}%
      </div>

      <div class="text-[12px] font-bold font-[ResourceHanRoundedCN] text-white">
        {{ score.level_value }} -&gt; {{ "%.1f" | format(score.dx_rating) }}
      </div>

      <div class="flex items-center">
        {# 等级图标 #}
        <div class="relative h-8 w-15">
          <img
            src="{{ RANK_ICON[score.rank] }}"
            alt="{{ score.rank }} rank"
            class="w-full h-full object-contain"
          />
        </div>

        {# FC 图标 #}
        <div class="flex h-[36px] w-[36px] items-center justify-center">
          {% if score.fc %}
          <img
            src="{{ COMBO_ICON[score.fc] }}"
            alt="Combo Icon"
            width="36"
            height="36"
            class="object-contain"
          />
          {% endif %}
        </div>

        {# FS/Sync 图标 #}
        <div class="mx-[-3px] flex h-[36px] w-[36px] items-center justify-center">
          {% if score.fs %}
          <img
            src="{{ SYNC_ICON[score.fs] }}"
            alt="Sync Icon"
            width="36"
            height="36"
            class="object-contain"
          />
          {% endif %}
        </div>

        {# DX Star 图标 #}
        <div class="flex h-[36px] w-[36px] items-center justify-center">
          {% if score.dx_star %}
          <img
            src="{{ DX_STAR_ICON[score.dx_star] }}"
            alt="DX Star Icon"
            width="60"
            height="36"
            class="object-contain"
          />
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</article>
{% endmacro %}